# Windowsタスクスケジューラ設定ガイド - 毎日7時・20時配信

## 概要

- **朝7時**: 過去24時間の記事を全ジャンル配信
- **夜20時**: 過去12時間の記事を全ジャンル配信

## 前提条件

### 1. .envファイルの設定確認

プロジェクトルートの `.env` ファイルに以下が設定されているか確認：

```env
GMAIL_USER=your-email@gmail.com
GMAIL_APP_PASSWORD=xxxx xxxx xxxx xxxx
NEWSLETTER_TO=recipient@example.com
ANTHROPIC_API_KEY=sk-ant-xxxxx
```

### 2. Gmailアプリパスワードの取得

1. Googleアカウントにログイン: https://myaccount.google.com/
2. 「セキュリティ」→「2段階認証プロセス」を有効化
3. 「セキュリティ」→「アプリパスワード」をクリック
4. アプリを選択: 「メール」、デバイスを選択: 「Windowsパソコン」
5. 生成された16桁のパスワードを `.env` の `GMAIL_APP_PASSWORD` に設定

### 3. 手動テスト実行

まず手動で正常に動作するか確認：

```bash
# テスト実行（メール送信なし）
npm run batch:test

# 実際に送信してみる
npm run batch
```

---

## タスクスケジューラの設定手順

### ステップ1: タスクスケジューラを開く

1. `Windows + R` キーを押す
2. `taskschd.msc` と入力してEnter
3. タスクスケジューラが起動します

### ステップ2: 朝7時の配信タスクを作成

#### 2-1. 基本タスクの作成

1. 左側のツリーから「タスクスケジューラライブラリ」を選択
2. 右側の「操作」パネルから「基本タスクの作成」をクリック

#### 2-2. 名前と説明

- **名前**: `投資ニュースレター配信_朝7時`
- **説明**: `全ジャンルのニュースレターを毎朝7時に配信（過去24時間）`
- 「次へ」をクリック

#### 2-3. トリガー

- **タスクの開始**: 「毎日」を選択
- 「次へ」をクリック

#### 2-4. 毎日

- **開始**: 今日の日付、時刻を `7:00:00` に設定
- **間隔**: `1` 日ごと
- 「次へ」をクリック

#### 2-5. 操作

- **操作**: 「プログラムの開始」を選択
- 「次へ」をクリック

#### 2-6. プログラムの開始

- **プログラム/スクリプト**:
  ```
  C:\Users\Yuji\dev\collect-blog-articles\run-daily-newsletters.bat
  ```

- **開始 (オプション)**:
  ```
  C:\Users\Yuji\dev\collect-blog-articles
  ```

- 「次へ」をクリック

#### 2-7. 完了

- ☑ 「完了をクリックしたときに、このタスクのプロパティダイアログを開く」にチェック
- 「完了」をクリック

#### 2-8. プロパティの詳細設定

プロパティダイアログが開くので、以下を設定：

**【全般】タブ**:
- ☑ `ユーザーがログオンしているかどうかにかかわらず実行する`
- ☑ `最上位の特権で実行する`

**【トリガー】タブ**:
- トリガーをダブルクリックして編集
- ☑ `有効` にチェックが入っているか確認

**【条件】タブ**:
- ☐ `コンピューターをAC電源で使用している場合のみタスクを開始する` のチェックを**外す**
- ☑ `タスクを実行するためにスリープを解除する` にチェック

**【設定】タブ**:
- ☑ `タスクが失敗した場合の再起動の間隔`: `1分`
- `再起動の試行回数`: `3`
- ☑ `タスクを要求時に実行する`
- `実行中のタスクが終了しない場合、強制的に停止するまでの時間`: `1時間`

**【OK】をクリック**

パスワードを求められたら、Windowsログインパスワードを入力してください。

---

### ステップ3: 夜20時の配信タスクを作成

同様の手順で、夜20時用のタスクを作成します。

#### 3-1 ～ 3-5: 上記と同じ手順

- **名前**: `投資ニュースレター配信_夜20時`
- **説明**: `全ジャンルのニュースレターを毎晩20時に配信（過去12時間）`
- **開始時刻**: `20:00:00`

#### 3-6. プログラムの開始（ここが異なる）

夜20時版は過去12時間の記事のみを対象にするため、専用のバッチファイルを作成します。

**まず、夜版のバッチファイルを作成**:

プロジェクトフォルダに `run-evening-newsletters.bat` を作成（後述のファイルを使用）

**プログラム/スクリプト**:
```
C:\Users\Yuji\dev\collect-blog-articles\run-evening-newsletters.bat
```

**開始 (オプション)**:
```
C:\Users\Yuji\dev\collect-blog-articles
```

#### 3-7 ～ 3-8: 上記と同じ設定

---

## バッチファイルの作成

### 朝7時版（既存）

`run-daily-newsletters.bat` - すでに作成済み

### 夜20時版（新規作成）

`run-evening-newsletters.bat` を以下の内容で作成：

```bat
@echo off
REM ニュースレター夜版配信スクリプト（過去12時間）
REM Windowsタスクスケジューラから実行されることを想定

cd /d %~dp0

echo ================================
echo ニュースレター夜版配信開始
echo 実行時刻: %date% %time%
echo ================================

REM 過去12時間の記事を取得
node src\batch-newsletter.js --hours 12

echo.
echo ================================
echo 処理完了: %date% %time%
echo ================================

REM ログファイルに追記
echo [%date% %time%] Evening newsletter batch completed >> logs\batch-newsletter.log
```

---

## タスクのテスト実行

### タスクが正しく作成されたか確認

1. タスクスケジューラで「タスクスケジューラライブラリ」を選択
2. 一覧に以下の2つのタスクが表示されることを確認：
   - `投資ニュースレター配信_朝7時`
   - `投資ニュースレター配信_夜20時`

### 手動実行でテスト

1. タスクを右クリック → 「実行」
2. 状態が「実行中」になることを確認
3. しばらく待つ（AI分析があるので数分かかります）
4. `output/` フォルダに最新のHTMLファイルが生成されていることを確認
5. メールが届いたか確認

---

## トラブルシューティング

### ❌ タスクが実行されない

**確認事項**:

1. **タスクの履歴を確認**:
   - タスクスケジューラで対象タスクを選択
   - 下部の「履歴」タブで実行結果を確認
   - エラーコードが表示されている場合、その内容を確認

2. **バッチファイルのパスを確認**:
   - タスクのプロパティ → 「操作」タブ
   - パスが正しいか確認（手動でバッチファイルをダブルクリックして動作するか確認）

3. **実行権限を確認**:
   - 「最上位の特権で実行する」にチェックが入っているか
   - ユーザーアカウントに管理者権限があるか

### ❌ タスクは実行されるがメールが送信されない

**確認事項**:

1. **環境変数ファイルを確認**:
   ```bash
   cat .env
   ```
   - GMAIL_USER、GMAIL_APP_PASSWORD、NEWSLETTER_TO が正しく設定されているか

2. **手動実行で確認**:
   ```bash
   npm run batch
   ```
   - エラーメッセージを確認

3. **Gmailアプリパスワードを再生成**:
   - 古いアプリパスワードが無効になっている可能性

### ❌ タスクが途中で停止する

**確認事項**:

1. **タイムアウト設定を延長**:
   - タスクのプロパティ → 「設定」タブ
   - 「実行中のタスクが終了しない場合、強制的に停止するまでの時間」を`3時間`に延長

2. **記事数が多すぎる**:
   - AI分析に時間がかかりすぎている可能性
   - `--no-ai` オプションでAI分析をスキップして試す

### ❌ 同じメールが複数届く

**原因**: タスクが重複して登録されている

**対処**:
1. タスクスケジューラで重複タスクを削除
2. 1つのタスクのみ残す

---

## ログの確認方法

### ログディレクトリの作成

```bash
mkdir logs
```

### ログファイルの確認

```bash
# 最新100行を表示
type logs\batch-newsletter.log

# リアルタイムで監視（PowerShell）
powershell -command "Get-Content logs\batch-newsletter.log -Wait"
```

---

## よくある質問

### Q1: 週末は配信したくない

**A**: トリガーの設定を変更します。

1. タスクのプロパティ → 「トリガー」タブ
2. トリガーをダブルクリック
3. 「毎日」から「毎週」に変更
4. 月曜〜金曜にチェック

### Q2: 祝日は配信したくない

**A**: 条件を追加で設定できます（少し複雑）。

または、祝日当日に手動でタスクを無効化する方が簡単です：
1. タスクを右クリック → 「無効化」
2. 翌日に「有効化」

### Q3: 特定のジャンルだけ配信したい

**A**: バッチファイルを編集します。

```bat
REM 個人投資家とマクロ経済のみ
node src\batch-newsletter.js --genres investors,macro
```

### Q4: 配信時刻を変更したい

**A**: タスクのプロパティから変更できます。

1. タスクを右クリック → 「プロパティ」
2. 「トリガー」タブ → トリガーをダブルクリック
3. 時刻を変更して「OK」

### Q5: コンピューターがスリープ中でも実行したい

**A**: タスクのプロパティで設定します。

1. 「条件」タブ
2. ☑ 「タスクを実行するためにスリープを解除する」にチェック

---

## 設定完了チェックリスト

- [ ] `.env` ファイルにメール設定を記載
- [ ] Gmailアプリパスワードを取得・設定
- [ ] 手動テスト実行成功（`npm run batch`）
- [ ] `run-evening-newsletters.bat` を作成
- [ ] タスクスケジューラに朝7時のタスクを作成
- [ ] タスクスケジューラに夜20時のタスクを作成
- [ ] 朝7時タスクの詳細設定完了
- [ ] 夜20時タスクの詳細設定完了
- [ ] 朝7時タスクを手動実行してテスト
- [ ] 夜20時タスクを手動実行してテスト
- [ ] メール受信を確認
- [ ] ログディレクトリ作成（`logs/`）

すべてチェックできたら設定完了です！🎉

---

## サポート

問題が解決しない場合は、以下の情報を確認してください：

1. タスクの履歴（エラーコード）
2. ログファイルの内容（`logs/batch-newsletter.log`）
3. 手動実行時のエラーメッセージ
